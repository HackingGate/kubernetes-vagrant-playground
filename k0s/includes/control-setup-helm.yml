- name: Check if Helm is already installed
  command: which helm
  register: helm_check
  ignore_errors: true
  changed_when: false

- name: Download Helm install script
  get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: /tmp/get_helm.sh
    mode: "0755"
  when: helm_check.rc != 0

- name: Install Helm
  command: /tmp/get_helm.sh
  when: helm_check.rc != 0

- name: Clean up Helm install script
  file:
    path: /tmp/get_helm.sh
    state: absent
  when: helm_check.rc != 0

- name: Add stable Helm repository
  command: helm repo add stable https://charts.helm.sh/stable
  register: helm_repo_add
  changed_when: helm_repo_add.rc == 0
  ignore_errors: true

- name: Update Helm repositories
  command: helm repo update
  register: helm_repo_update
  changed_when: helm_repo_update.rc == 0
