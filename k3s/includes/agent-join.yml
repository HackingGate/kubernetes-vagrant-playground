- name: Waiting for src ./k3s-join.sh to be present on local
  become: false
  wait_for:
    path: "./k3s-join.sh"
    state: present
    timeout: 600
  delegate_to: localhost

- name: Check if k3s agent is already running
  shell: systemctl is-active k3s-agent
  register: k3s_agent_check
  ignore_errors: true
  changed_when: false

- name: Push join script to /tmp/k3s-join.sh on each agent
  copy:
    src: ./k3s-join.sh
    dest: /tmp/k3s-join.sh
    mode: "0755"
  when: k3s_agent_check.rc != 0

- name: "Join the agent to cluster"
  shell: /tmp/k3s-join.sh {{ ansible_host }}
  register: join_command_result
  until: join_command_result.rc == 0
  retries: 30
  delay: 5
  when: k3s_agent_check.rc != 0

- name: Clean up join script
  file:
    path: /tmp/k3s-join.sh
    state: absent
  when: k3s_agent_check.rc != 0
